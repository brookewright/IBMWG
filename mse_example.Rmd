---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#devtools::install_github("timjmiller/wham", dependencies=TRUE, ref = "om_mode")
library(wham)
library(tidyverse)
library(furrr)
source("performance_metrics.R")
source("wham_mse_functions.R")
```

## wham example 

from simple_example_2.R
`get_input()` gets the input list for a given scenario

`do_wham_mse_sim()` runs a given simulation
will want to abstract more of the set up from this as it's the same for each simulation


## Set up some scenarios, dimensions, and run the MSE

```{r}
#dimension problem
nbase = 2 #number of scenarios
nsim = 2

#generate seeds
sim.seeds <- sample(1:1000000,
                    nbase*nsim,
                    replace = FALSE)

#set up output tibble
mse_output <- tibble(iscen = rep(1:nbase, each = nsim),
                     isim = rep(1:nsim, times = nbase),
                     seed = sim.seeds)

#get inputs for scenarios
input_lists <- tibble(iscen = 1:nbase) %>% 
  mutate(input = map(1:nbase, ~get_input(.x)))
mse_output <- mse_output %>% 
  left_join(input_lists) 

#do the MSE for all simulations and scenarios
future::plan(future::multiprocess)
mse_output <- mse_output %>% 
#   mutate(wham = purrr::pmap(list(seed, input),
#                              ~do_wham_mse_sim(seed = .x,
#                                               input = .y,
#                                               nprojyrs = 40)))
  mutate(wham = furrr::future_pmap(list(seed, input),
                            ~do_wham_mse_sim(seed = .x,
                                             input = .y,
                                             nprojyrs = 40)))
```

pull out some parts of the output
calculate some performance metrics

```{r}
nprojyrs <- 40
mse_results <- mse_output %>% 
  mutate(om_ssb = map(wham,
                  ~pluck(.x$sim_data_series[[nprojyrs+1]]$SSB)),
         refpts = map(wham, "refpts"),
         ssb_metrics = pmap(list(om_ssb, refpts), get_ssb_metrics, nprojyrs = 40))
```

`mse_results` is a tibble containing the results, and vectors of the OM SSB, and a list of SSB performance metrics (fudging using SSBlim as SSBMSY for this demo)

pull out the ssb metrics

```{r}
ssb_results <- mse_results %>% 
  select(iscen, isim, ssb_metrics) %>% 
  mutate(ssb_metrics = map(ssb_metrics, enframe)) %>% 
  unnest() %>% 
  mutate(value = map_dbl(value, I)) %>% 
  rename(metric = name) %>% 
  I()
ssb_results
```

summarize across simulations by scenario
25%, 50%, 75% quantiles
```{r}
quibble <- function(x, q = c(0.25, 0.5, 0.75)) {
  tibble(x = quantile(x, q), q = q)
}

ssb_summary <- ssb_results %>% 
  group_by(metric, iscen) %>% 
  summarise(y = list(quibble(value, c(0.25, 0.5, 0.75)))) %>% 
  tidyr::unnest(y) %>% 
  I()
ssb_summary
```

